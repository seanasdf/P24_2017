{
    "collab_server" : "",
    "contents" : "library(rvest)\nlibrary(tidyverse)\nlibrary(stringr)\nlibrary(lubridate)\n\n# load cached p24 data\nif (file.exists(\"teamdata.rda\")) {\n  load(\"teamdata.rda\")\n} else{\n  \n  #read in leaderboard\n  ldrboard <- read_html(\"http://leaderboard.powderhorn24.com/\")\n  \n  #get list of team numbers\n  teams <- html_nodes(ldrboard, \"td:nth-child(6)\") %>% \n    as.character() \n  \n  #convert list of team numbers to URLS, pull down data\n  teampages <- map(teams, str_extract, \"\\\\/[0-9]{1,4}\") %>% \n    str_extract(\"[0-9]{1,4}\") %>% \n    paste0(\"http://leaderboard.powderhorn24.com/teams/\", .) %>% \n    map(read_html) \n  \n  #get team name from team page\n  tm_name <- map(teampages, html_nodes, \"h3\") %>% \n    map(html_text) \n  \n  #get team category from leaderboard\n  tm_cat <- map(teampages, html_nodes, \"dd:nth-child(2)\") %>% \n    map_chr(html_text)\n  \n  #get team data from team page\n  tm_data <- map(teampages, html_nodes, \"#laps-list-table\") %>% \n    map(html_table)\n  \n  \n  #save objects to cache them\n  save(ldrboard, tm_cat, tm_name, tm_data, file=\"teamdata.rda\")\n}\n\n#unlist and clean up team names\ntm_name <- unlist(tm_name) %>% \n  map_chr(trimws, which=\"both\")\n\n\n#Pull all laps into one big Df, calculate datetime of each lap.\nlaps <- map(tm_data, 1) %>%\n  map2(tm_name,\n          ~mutate(.x, team=.y)) %>% \n  map2(tm_cat,\n       ~mutate(.x, category=.y)) %>% \n  bind_rows() %>% \n  tbl_df() %>% \n  mutate(rider_num = str_extract(Rider, \"\\\\([0-9]{1,3}\"),\n      rider_num = str_extract(rider_num, \"[0-9]{1,3}\"), \n      rider_name = str_extract(Rider, \"^(.*?)\\\\(\"),\n      rider_name = substr(rider_name, 1, nchar(rider_name)-2),\n      time = parse_date_time(Time, \"hmsp\"),\n      day = ifelse(hour(time)>=19 & hour(time) <=23, \"Friday\", \"Saturday\"),\n      datetime = ifelse(day==\"Friday\", paste0(\"8/18/2017, \", Time), paste0(\"8/19/2017, \", Time)),\n      datetime = mdy_hms(datetime)\n  ) %>% \n  select(-Time, -Rider, -time)\n\n\n# get breakpoints for hours and variable\nhourbreaks <- mdy_hm(\"08-18-2017, 19:00\") + hours(1)*c(1:23) \nvars <- map_chr(hourbreaks, function(x) paste0(\"hour\", \n                                               ifelse(hour(x)>=20, hour(x)-19, hour(x)+5)))\n\n# number of laps at each hour interval, by team\nlaps <- map2_df(vars, hourbreaks, function(x,y) {\n  varname <- quo_name(x)\n  laps <- laps %>% \n    group_by(team) %>% \n    mutate(!!varname := sum(datetime<y))\n})\n\n\n#vacation stops\nvacay <- tbl_df(tm_name) %>% \n  set_names(\"team\") \n\nblah <- map(tm_data, 2)\nblah <- replace(blah, map(blah, is.null), \"Z\")\n",
    "created" : 1503452710153.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1696937736",
    "id" : "DDEFED5",
    "lastKnownWriteTime" : 1503788811,
    "last_content_update" : 1503788811101,
    "path" : "~/rprojects/powderhorn24/p24.R",
    "project_path" : "p24.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}